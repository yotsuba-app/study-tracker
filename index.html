<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Time Tracker</title>

<style>
body {
  font-family: system-ui, -apple-system, sans-serif;
  padding: 16px;
  background-color: #f8f9fa;
  color: #333;
}

h2 {
  margin: 8px 0 12px;
  font-size: 1.2rem;
}

/* タブ */
#tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
}

.tab-btn {
  padding: 8px 16px;
  border-radius: 6px;
  border: 1px solid #ddd;
  background: #fff;
  cursor: pointer;
  transition: 0.2s;
}

.tab-btn.active {
  background: #4a90e2;
  color: #fff;
  border-color: #4a90e2;
  font-weight: 600;
}

/* ナビゲーションバー */
#nav-bar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.nav-btn {
  cursor: pointer;
  padding: 4px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #fff;
}
.nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}
.nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}
/* モードトグル */
#mode-toggle {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 6px;
}

.toggle-label {
  cursor: pointer;
  padding: 3px 12px;
  border-radius: 15px;
  border: 1px solid #ccc;
  background: #fff;
  font-size: 13px;
}

.toggle-label.active {
  background: #4a90e2;
  color: #fff;
  border-color: #4a90e2;
}

/* 【修正1】グリッドのコンテナ：横スクロールを可能に */
#grid-container {
  width: 100%;
  overflow-x: auto; /* 横幅が足りない時にスクロール */
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #fff;
}

.grid {
  display: grid;
  font-size: 12px;
  min-width: max-content; /* 中身に合わせて幅を広げる */
}

.cell {
  border-right: 1px solid #eee;
  border-bottom: 1px solid #eee;
  height: 30px;
  line-height: 30px;
  text-align: center;
  cursor: pointer;
  box-sizing: border-box;
}

.time {
  background: #f8f9fa;
  cursor: default;
  font-weight: 500;
  position: sticky; /* 左側の時間を固定 */
  left: 0;
  z-index: 10;
  border-right: 2px solid #ddd;
}
/* 土曜日：薄い青 */
.sat {
  color: #0000ff;
  background-color: #e6f0ff !important;
}

/* 日曜日・祝日：薄い赤 */
.sun, .holiday {
  color: #ff0000;
  background-color: #ffe6e6 !important;
}
.study { background: #4a90e2 !important; }

/* ハイライト */
.today-col { background-color: #fff9db; }
.now-row { border-top: 2px solid #ff922b; border-bottom: 2px solid #ff922b; }
.now-today { background-color: #ffec99 !important; font-weight: bold; }

#calendar-view, #graph-view { display: none; }
#calendar-view.active, #graph-view.active { display: block; }

canvas { max-width: 100%; height: auto !important; }
</style>
</head>

<body>

<div id="tabs">
  <button class="tab-btn active" id="tab-calendar">カレンダー</button>
  <button class="tab-btn" id="tab-graph">グラフ</button>
</div>

<div id="calendar-view" class="active">
  <div id="nav-bar">
    <button class="nav-btn" id="prev-year">←年</button>
    <span id="year-label"></span>
    <button class="nav-btn" id="next-year">年→</button>

    <button class="nav-btn" id="prev-month">←月</button>
    <span id="month-label"></span>
    <button class="nav-btn" id="next-month">月→</button>
    <button class="nav-btn" id="next-month">月→</button>

<span style="margin-left: 10px; color: #ccc;">|</span>
<button class="nav-btn" id="prev-week">←週</button>
<button class="nav-btn" id="next-week">週→</button>

    <div id="mode-toggle">
      <span id="mode-month" class="toggle-label active">月</span>
      <span id="mode-week" class="toggle-label">週</span>
    </div>
  </div>

  <div id="week-range" style="margin-bottom: 8px; font-weight: bold;"></div>
  <h2 id="total"></h2>

  <div id="grid-container">
    <div class="grid" id="grid"></div>
  </div>
</div>

<div id="graph-view">
  <div id="graph-controls" style="margin-bottom: 15px;">
    <button class="tab-btn active" id="btn-month-graph">月グラフ</button>
    <button class="tab-btn" id="btn-week-graph">週グラフ</button>
  </div>
  <canvas id="chart-canvas"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const SLOTS = 48;
// 2026年の祝日リスト (月-日の形式)
const HOLIDAYS_2026 = [
  "1-1", "1-12", "2-11", "2-23", "3-20", "3-21", "4-29", 
  "5-3", "5-4", "5-5", "5-6", "7-20", "8-11", "9-21", 
  "9-22", "9-23", "10-12", "11-3", "11-23"
];
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;
let viewMode = "week"; 
let currentWeekIndex = 0;

function getDaysInMonth(year, month) { return new Date(year, month, 0).getDate(); }

function loadState(year, month) {
  const key = `study-log-${year}-${month}`;
  const saved = localStorage.getItem(key);
  const days = getDaysInMonth(year, month);
  return saved ? JSON.parse(saved) : Array.from({ length: days }, () => Array(SLOTS).fill(0));
}

function saveState() {
  const key = `study-log-${currentYear}-${currentMonth}`;
  localStorage.setItem(key, JSON.stringify(state));
}

let state = loadState(currentYear, currentMonth);

function getWeeksInMonth(year, month) {
  const days = getDaysInMonth(year, month);
  const first = new Date(year, month - 1, 1);
  const firstDow = first.getDay();
  const weeks = [];
  let startOffset = -firstDow;
  while (true) {
    const startDate = 1 + startOffset;
    const endDate = startDate + 6;
    if (startDate > days) break;
    weeks.push({ start: Math.max(1, startDate), end: Math.min(days, endDate) });
    startOffset += 7;
  }
  return weeks;
}

function renderGrid() {
document.getElementById("prev-week").disabled = (viewMode !== "week");
  document.getElementById("next-week").disabled = (viewMode !== "week");
  const daysInMonth = getDaysInMonth(currentYear, currentMonth);
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  const weeks = getWeeksInMonth(currentYear, currentMonth);
  if (currentWeekIndex >= weeks.length) currentWeekIndex = weeks.length - 1;
  
  let dayStart = 1, dayEnd = daysInMonth;
  if (viewMode === "week") {
    const w = weeks[currentWeekIndex];
    dayStart = w.start; dayEnd = w.end;
    document.getElementById("week-range").textContent = `${currentMonth}/${w.start} 〜 ${currentMonth}/${w.end} の週`;
  } else {
    document.getElementById("week-range").textContent = "全日程表示";
  }

  const colCount = dayEnd - dayStart + 1;
  grid.style.gridTemplateColumns = `120px repeat(${colCount}, 40px)`;

  document.getElementById("year-label").textContent = `${currentYear}年`;
  document.getElementById("month-label").textContent = `${currentMonth}月`;

  // ヘッダー（日付）
  const corner = document.createElement("div");
  corner.textContent = "時間＼日";
  corner.className = "cell time";
  grid.append(corner);

 for (let d = dayStart; d <= dayEnd; d++) {
    const h = document.createElement("div");
    h.textContent = d;
    h.className = "cell time header-day";

    // 曜日の判定 (0:日, 1:月, ..., 6:土)
    const dateObj = new Date(currentYear, currentMonth - 1, d);
    const dayOfWeek = dateObj.getDay();
    const dateStr = `${currentMonth}-${d}`;

    // クラスの追加
    if (HOLIDAYS_2026.includes(dateStr)) {
      h.classList.add("holiday"); // 祝日
    } else if (dayOfWeek === 0) {
      h.classList.add("sun");     // 日曜
    } else if (dayOfWeek === 6) {
      h.classList.add("sat");     // 土曜
    }

    grid.append(h);
  }

  // 時間スロット
  for (let t = 0; t < SLOTS; t++) {
    const label = document.createElement("div");
    // 開始時刻の計算
    const startH = String(Math.floor(t / 2)).padStart(2, "0");
    const startM = t % 2 === 0 ? "00" : "30";
    
    // 終了時刻の計算（30分後）
    const endTotalMin = (t + 1) * 30;
    const endH = String(Math.floor(endTotalMin / 60)).padStart(2, "0");
    const endM = (endTotalMin % 60 === 0) ? "00" : "30";

    label.textContent = `${startH}:${startM}–${endH}:${endM}`;
    label.className = "cell time";
    grid.append(label);

    for (let d = dayStart; d <= dayEnd; d++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.day = d;
      cell.dataset.slot = t;
      paint(cell, state[d - 1][t]);

      cell.onclick = () => {
        state[d - 1][t] = state[d - 1][t] === 0 ? 1 : 0;
        paint(cell, state[d - 1][t]);
        saveState();
        updateTotal();
      };
      grid.append(cell);
    }
  }
  updateTotal();
  highlightNow();
}

function paint(cell, v) {
  v === 1 ? cell.classList.add("study") : cell.classList.remove("study");
}

function updateTotal() {
  const total = state.flat().filter(v => v === 1).length * 0.5;
  document.getElementById("total").textContent = `今月の合計：${total} 時間`;
}

function highlightNow() {
  const now = new Date();
  const todayYear = now.getFullYear();
  const todayMonth = now.getMonth() + 1;
  const todayDate = now.getDate();
  const slot = now.getHours() * 2 + (now.getMinutes() >= 30 ? 1 : 0);

  const cells = document.querySelectorAll("#grid .cell:not(.time)");
  cells.forEach(cell => {
    const d = parseInt(cell.dataset.day);
    const s = parseInt(cell.dataset.slot);
    
    cell.classList.remove("today-col", "now-row", "now-today");
    if (currentYear === todayYear && currentMonth === todayMonth && d === todayDate) {
      cell.classList.add("today-col");
      if (s === slot) cell.classList.add("now-today");
    }
    if (s === slot) cell.classList.add("now-row");
  });
}
/* --- 週のナビゲーション --- */
document.getElementById("prev-week").onclick = () => {
  if (viewMode !== "week") return; // 週モードの時だけ動作

  if (currentWeekIndex > 0) {
    currentWeekIndex--;
  } else {
    // 前の月の最後の週へ移動
    currentMonth--;
    if (currentMonth === 0) { currentMonth = 12; currentYear--; }
    state = loadState(currentYear, currentMonth);
    const weeks = getWeeksInMonth(currentYear, currentMonth);
    currentWeekIndex = weeks.length - 1;
  }
  renderGrid();
};

document.getElementById("next-week").onclick = () => {
  if (viewMode !== "week") return; // 週モードの時だけ動作

  const weeks = getWeeksInMonth(currentYear, currentMonth);
  if (currentWeekIndex < weeks.length - 1) {
    currentWeekIndex++;
  } else {
    // 次の月の最初の週へ移動
    currentMonth++;
    if (currentMonth === 13) { currentMonth = 1; currentYear++; }
    state = loadState(currentYear, currentMonth);
    currentWeekIndex = 0;
  }
  renderGrid();
};
// 【修正3】1分ごとにハイライトを更新
setInterval(highlightNow, 60000);

/* --- イベント設定 --- */
document.getElementById("tab-calendar").onclick = () => {
  document.getElementById("tab-calendar").classList.add("active");
  document.getElementById("tab-graph").classList.remove("active");
  document.getElementById("calendar-view").classList.add("active");
  document.getElementById("graph-view").classList.remove("active");
};

document.getElementById("tab-graph").onclick = () => {
  document.getElementById("tab-graph").classList.add("active");
  document.getElementById("tab-calendar").classList.remove("active");
  document.getElementById("graph-view").classList.add("active");
  document.getElementById("calendar-view").classList.remove("active");
  drawCurrentGraph();
};

document.getElementById("prev-month").onclick = () => {
  currentMonth--;
  if (currentMonth === 0) { currentMonth = 12; currentYear--; }
  state = loadState(currentYear, currentMonth);
  renderGrid();
};

document.getElementById("next-month").onclick = () => {
  currentMonth++;
  if (currentMonth === 13) { currentMonth = 1; currentYear++; }
  state = loadState(currentYear, currentMonth);
  renderGrid();
};

document.getElementById("mode-month").onclick = () => {
  viewMode = "month";
  document.getElementById("mode-month").classList.add("active");
  document.getElementById("mode-week").classList.remove("active");
  renderGrid();
};

document.getElementById("mode-week").onclick = () => {
  viewMode = "week";
  document.getElementById("mode-week").classList.add("active");
  document.getElementById("mode-month").classList.remove("active");
  renderGrid();
};

/* --- グラフ関連（略） --- */
let chartInstance = null;
function drawCurrentGraph() {
  if (chartInstance) chartInstance.destroy();
  const ctx = document.getElementById("chart-canvas").getContext("2d");
  const daily = state.map(day => day.filter(v => v === 1).length * 0.5);
  chartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels: daily.map((_, i) => `${i + 1}日`),
      datasets: [{ label: "勉強時間(h)", data: daily, backgroundColor: "#4a90e2" }]
    }
  });
}

/* --- 初期起動の処理 --- */
// 1. 今日の日付に基づいて「今月の第何週か」を計算する関数
function getInitialWeekIndex() {
  const today = new Date();
  const weeks = getWeeksInMonth(today.getFullYear(), today.getMonth() + 1);
  const day = today.getDate();
  
  // 今日の日付が含まれる週の番号を探す
  for (let i = 0; i < weeks.length; i++) {
    if (day >= weeks[i].start && day <= weeks[i].end) {
      return i;
    }
  }
  return 0;
}

// 2. 起動時の設定
viewMode = "week"; // 最初から「週」モードにする
currentWeekIndex = getInitialWeekIndex(); // 今日のある週を計算してセット

// モード切り替えボタンの見た目（青色）も「週」に合わせておく
document.getElementById("mode-week").classList.add("active");
document.getElementById("mode-month").classList.remove("active");

// 最後に描画を実行
renderGrid();
</script>
</body>
</html>