<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Study Time Tracker</title>

<style>
body { font-family: system-ui, sans-serif; padding: 16px; }
h2 { margin: 8px 0 12px; }

/* ボタン */
button { margin-right: 6px; }

/* グリッド */
.grid { display: grid; font-size: 12px; }
.cell {
  border: 1px solid #ccc;
  height: 28px;
  line-height: 28px;
  text-align: center;
  cursor: pointer;
}
.time {
  background: #f3f3f3;
  cursor: default;
  font-weight: 500;
}
.study { background: #4a90e2; }

/* ハイライト */
.today-col { outline: 2px solid #ffd9b3; outline-offset: -2px; }
.now-row { outline: 2px solid #ffe8cc; outline-offset: -2px; }
.now-today { outline: 2px solid #ffbf80; outline-offset: -2px; }
</style>
</head>

<body>

<button id="loadBtn">クラウドから読み込み</button>
<button id="saveBtn">クラウドへ保存</button>

<h2 id="total"></h2>
<div class="grid" id="grid"></div>

<script>
/* ===============================
   設定
=============================== */
const GAS_URL =
"https://script.google.com/macros/s/AKfycbwXtsf3xyCZDW6i8WR4JtNwJ8XZejrcLP8_uIeGzUa_fK5Pw8T4_Zsk_TLXilzCC17viQ/exec";

const SLOTS = 48;
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth() + 1;

/* ===============================
   State管理
=============================== */
function getDaysInMonth(y, m) {
  return new Date(y, m, 0).getDate();
}

function emptyState(y, m) {
  return Array.from(
    { length: getDaysInMonth(y, m) },
    () => Array(SLOTS).fill(0)
  );
}

let state = emptyState(currentYear, currentMonth);

/* ===============================
   描画
=============================== */
function renderGrid() {
  const days = getDaysInMonth(currentYear, currentMonth);
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  grid.style.gridTemplateColumns = `140px repeat(${days}, 36px)`;

  grid.append(cell("時間＼日", true));
  for (let d = 1; d <= days; d++) grid.append(cell(d, true));

  for (let t = 0; t < SLOTS; t++) {
    const h = String(Math.floor(t / 2)).padStart(2, "0");
    const m = t % 2 === 0 ? "00" : "30";
    grid.append(cell(`${h}:${m}`, true));

    for (let d = 0; d < days; d++) {
      const c = cell("");
      paint(c, state[d][t]);
      c.onclick = () => {
        state[d][t] ^= 1;
        paint(c, state[d][t]);
        updateTotal();
        highlightNow();
      };
      grid.append(c);
    }
  }
  updateTotal();
  highlightNow();
}

function cell(text, isTime = false) {
  const d = document.createElement("div");
  d.textContent = text;
  d.className = "cell" + (isTime ? " time" : "");
  return d;
}

function paint(cell, v) {
  cell.classList.toggle("study", v === 1);
}

function updateTotal() {
  const h = state.flat().filter(v => v).length * 0.5;
  document.getElementById("total").textContent =
    `${currentYear}年${currentMonth}月の勉強時間：${h} 時間`;
}

/* ===============================
   ハイライト
=============================== */
function highlightNow() {
  const now = new Date();
  if (
    now.getFullYear() !== currentYear ||
    now.getMonth() + 1 !== currentMonth
  ) return;

  const slot = now.getHours() * 2 + (now.getMinutes() >= 30 ? 1 : 0);
  const col = now.getDate();

  const days = getDaysInMonth(currentYear, currentMonth);
  const cells = document.querySelectorAll("#grid .cell");

  cells.forEach((c, i) => {
    c.classList.remove("today-col", "now-row", "now-today");
    const r = Math.floor(i / (days + 1));
    const cl = i % (days + 1);
    if (cl === col) c.classList.add("today-col");
    if (r === slot + 1) c.classList.add("now-row");
    if (cl === col && r === slot + 1) c.classList.add("now-today");
  });
}

/* ===============================
   クラウド保存／読込
=============================== */
async function saveToCloud() {
  await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      year: currentYear,
      month: currentMonth,
      state
    })
  });
  alert("クラウドへ保存しました");
}

async function loadFromCloud() {
  const res = await fetch(
    `${GAS_URL}?year=${currentYear}&month=${currentMonth}`
  );
  const data = await res.json();
  if (data?.state) {
    state = data.state;
    renderGrid();
  }
}

/* ===============================
   ボタン
=============================== */
document.getElementById("saveBtn").onclick = saveToCloud;
document.getElementById("loadBtn").onclick = loadFromCloud;

/* 初期描画 */
renderGrid();
</script>

</body>
</html>




